<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í†µí•© ë§¤ì¶œ ê´€ë¦¬ - ì‹œí‹°ë°˜ì  POS</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .sales-management-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }
    
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .page-header h2 {
      font-size: 1.8em;
      color: #1976d2;
      margin: 0;
    }
    
    .btn-add {
      background: #4caf50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-add:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .date-filter {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .date-filter input {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .date-filter button {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1976d2;
    }
    
    .stat-card .stat-label {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    .section-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .section-card h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
      font-size: 1.3em;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1976d2;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1565c0;
    }
    
    .btn-secondary {
      background: #757575;
      color: white;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .data-table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #333;
    }
    
    .data-table tr:hover {
      background: #f9f9f9;
    }
    
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .chart-container h3 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: #333;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab-btn.active {
      color: #1976d2;
      border-bottom-color: #1976d2;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @media (max-width: 768px) {
      .sales-management-container {
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1 data-store-name>ğŸ® ì‹œí‹°ë°˜ì </h1>
    </div>
    <div class="header-controls">
      <a href="/pos" style="color: white; text-decoration: none; padding: 8px 14px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 13px;">â† ì£¼ë¬¸ ê´€ë¦¬</a>
    </div>
  </div>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
  <div class="side-menu" id="side-menu">
    <div class="side-menu-header">
      <h2>ğŸ“Š ë©”ë‰´</h2>
      <button class="close-btn" onclick="toggleMenu()">âœ•</button>
    </div>
    <nav class="side-menu-nav">
      <a href="/pos" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“‹</span>
        <span class="menu-text">ì „ì²´í˜„í™©Â·ì„ì‹œì¤‘ì§€</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/store-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸª</span>
        <span class="menu-text">ê°€ê²Œê´€ë¦¬</span>
      </a>
      <a href="/pos/dashboard.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“Š</span>
        <span class="menu-text">ê°€ê²Œí†µê³„</span>
        <span class="menu-badge">ì—…ë°ì´íŠ¸</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/menu-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“</span>
        <span class="menu-text">ê°€ê²Œ ë©”ë‰´íŒ í¸ì§‘</span>
      </a>
      <a href="/pos/menu-management.html?tab=options" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">âš™ï¸</span>
        <span class="menu-text">ë©”ë‰´Â·ì˜µì…˜ ê´€ë¦¬</span>
      </a>
      <a href="/pos/menu-management.html?tab=discounts" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ·ï¸</span>
        <span class="menu-text">ë©”ë‰´ë³„ í• ì¸ ê´€ë¦¬</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/dashboard.html?tab=settlement" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ’°</span>
        <span class="menu-text">ì •ì‚° ì •ë³´</span>
      </a>
      <a href="/pos/dashboard.html?tab=customers" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ‘¥</span>
        <span class="menu-text">ê³ ê° ë¶„ì„</span>
      </a>
      <a href="/pos/dashboard.html?tab=regions" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“</span>
        <span class="menu-text">ì§€ì—­ ë¶„ì„</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/point-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ’°</span>
        <span class="menu-text">í¬ì¸íŠ¸ ê´€ë¦¬</span>
      </a>
      <a href="/pos/coupon-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ«</span>
        <span class="menu-text">ì¿ í° ê´€ë¦¬</span>
      </a>
      <a href="/pos/total-sales-management.html" class="menu-item active" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“ˆ</span>
        <span class="menu-text">í†µí•© ë§¤ì¶œ ê´€ë¦¬</span>
      </a>
      <div class="menu-divider"></div>
      <a href="javascript:void(0)" class="menu-item" onclick="openSiteEditor(); toggleMenu();">
        <span class="menu-icon">ğŸ¨</span>
        <span class="menu-text">ì‚¬ì´íŠ¸ ë””ìì¸ í¸ì§‘</span>
      </a>
      <a href="javascript:void(0)" class="menu-item" onclick="openVolumeSettings(); toggleMenu();">
        <span class="menu-icon">ğŸ”Š</span>
        <span class="menu-text">ì£¼ë¬¸ ì†Œë¦¬ í¬ê¸°</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/login.html" class="menu-item" onclick="sessionStorage.removeItem('pos-authenticated'); toggleMenu();">
        <span class="menu-icon">ğŸšª</span>
        <span class="menu-text">ë¡œê·¸ì•„ì›ƒ</span>
      </a>
    </nav>
  </div>
  
  <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>

  <div class="sales-management-container">
    <div class="page-header">
      <h2>ğŸ“ˆ í†µí•© ë§¤ì¶œ ê´€ë¦¬</h2>
    </div>

    <!-- ë‚ ì§œ í•„í„° -->
    <div class="date-filter">
      <label>ì‹œì‘ì¼:</label>
      <input type="date" id="start-date" value="">
      <label>ì¢…ë£Œì¼:</label>
      <input type="date" id="end-date" value="">
      <button onclick="loadStats()">ì¡°íšŒ</button>
      <button onclick="resetDateFilter()" style="background: #757575;">ì „ì²´</button>
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>ë°°ë‹¬ì•± ë§¤ì¶œ</h3>
        <div class="stat-value" id="stat-app-sales">0</div>
        <div class="stat-label" id="stat-app-count">0ê±´</div>
      </div>
      <div class="stat-card">
        <h3>í™€ ë§¤ì¶œ</h3>
        <div class="stat-value" id="stat-hall-sales">0</div>
        <div class="stat-label" id="stat-hall-count">0ê±´</div>
      </div>
      <div class="stat-card">
        <h3>íƒ€ í”Œë«í¼ ë§¤ì¶œ</h3>
        <div class="stat-value" id="stat-platform-sales">0</div>
        <div class="stat-label" id="stat-platform-count">0ê±´</div>
      </div>
      <div class="stat-card">
        <h3>ì´ ë§¤ì¶œ</h3>
        <div class="stat-value" id="stat-total-sales">0</div>
        <div class="stat-label">í†µí•© ë§¤ì¶œ</div>
      </div>
      <div class="stat-card">
        <h3>ìˆœë§¤ì¶œ</h3>
        <div class="stat-value" id="stat-net-sales">0</div>
        <div class="stat-label">ìˆ˜ìˆ˜ë£Œ ì œì™¸</div>
      </div>
      <div class="stat-card">
        <h3>í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ</h3>
        <div class="stat-value" id="stat-commission">0</div>
        <div class="stat-label">ê³µì œì•¡</div>
      </div>
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('overview')">ğŸ“Š í†µí•© í˜„í™©</button>
      <button class="tab-btn" onclick="switchTab('hall')">ğŸª í™€ ë§¤ì¶œ</button>
      <button class="tab-btn" onclick="switchTab('platform')">ğŸ“± íƒ€ í”Œë«í¼</button>
      <button class="tab-btn" onclick="switchTab('charts')">ğŸ“ˆ ì°¨íŠ¸</button>
    </div>

    <!-- í†µí•© í˜„í™© íƒ­ -->
    <div id="tab-overview" class="tab-content active">
      <div class="section-card">
        <h3>ğŸ“Š ë§¤ì¶œ êµ¬ì„±</h3>
        <div class="chart-container">
          <canvas id="sales-composition-chart"></canvas>
        </div>
      </div>
      
      <div class="section-card">
        <h3>ğŸ“± í”Œë«í¼ë³„ ë§¤ì¶œ</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>í”Œë«í¼</th>
              <th>ë§¤ì¶œì•¡</th>
              <th>ìˆ˜ìˆ˜ë£Œ</th>
              <th>ìˆœë§¤ì¶œ</th>
              <th>ê±´ìˆ˜</th>
            </tr>
          </thead>
          <tbody id="platform-breakdown-table">
            <tr><td colspan="5" class="loading">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- í™€ ë§¤ì¶œ íƒ­ -->
    <div id="tab-hall" class="tab-content">
      <div class="section-card">
        <h3>â• í™€ ë§¤ì¶œ ì…ë ¥</h3>
        <form id="hall-sale-form">
          <div class="form-row">
            <div class="form-group">
              <label>ë‚ ì§œ</label>
              <input type="date" id="hall-date" required>
            </div>
            <div class="form-group">
              <label>ë§¤ì¶œì•¡ (ì›)</label>
              <input type="number" id="hall-amount" min="0" required placeholder="ë§¤ì¶œì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ê²°ì œ ë°©ë²•</label>
              <select id="hall-payment" required>
                <option value="cash">í˜„ê¸ˆ</option>
                <option value="card">ì¹´ë“œ</option>
                <option value="mixed">í˜¼í•©</option>
              </select>
            </div>
            <div class="form-group">
              <label>ë©”ëª¨</label>
              <input type="text" id="hall-memo" placeholder="ë¹„ê³  (ì„ íƒì‚¬í•­)">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">ë§¤ì¶œ ë“±ë¡</button>
        </form>
      </div>

      <div class="section-card">
        <h3>ğŸ“‹ í™€ ë§¤ì¶œ ë‚´ì—­</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>ë‚ ì§œ</th>
              <th>ë§¤ì¶œì•¡</th>
              <th>ê²°ì œ ë°©ë²•</th>
              <th>ë©”ëª¨</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody id="hall-sales-table">
            <tr><td colspan="5" class="loading">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- íƒ€ í”Œë«í¼ íƒ­ -->
    <div id="tab-platform" class="tab-content">
      <div class="section-card">
        <h3>â• íƒ€ í”Œë«í¼ ë§¤ì¶œ ì…ë ¥</h3>
        <form id="platform-sale-form">
          <div class="form-row">
            <div class="form-group">
              <label>í”Œë«í¼</label>
              <select id="platform-name" required>
                <option value="baemin">ë°°ë‹¬ì˜ë¯¼ì¡±</option>
                <option value="yogiyo">ìš”ê¸°ìš”</option>
                <option value="coupang">ì¿ íŒ¡ì´ì¸ </option>
                <option value="shuttle">ë°°ë‹¬íŠ¹ê¸‰</option>
                <option value="etc">ê¸°íƒ€</option>
              </select>
            </div>
            <div class="form-group">
              <label>ë‚ ì§œ</label>
              <input type="date" id="platform-date" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ë§¤ì¶œì•¡ (ì›)</label>
              <input type="number" id="platform-amount" min="0" required placeholder="ë§¤ì¶œì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
              <label>ìˆ˜ìˆ˜ë£Œ (ì›)</label>
              <input type="number" id="platform-commission" min="0" value="0" placeholder="ìˆ˜ìˆ˜ë£Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ê²°ì œ ë°©ë²•</label>
              <select id="platform-payment" required>
                <option value="card">ì¹´ë“œ</option>
                <option value="cash">í˜„ê¸ˆ</option>
              </select>
            </div>
            <div class="form-group">
              <label>ë©”ëª¨</label>
              <input type="text" id="platform-memo" placeholder="ë¹„ê³  (ì„ íƒì‚¬í•­)">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">ë§¤ì¶œ ë“±ë¡</button>
        </form>
      </div>

      <div class="section-card">
        <h3>ğŸ“‹ íƒ€ í”Œë«í¼ ë§¤ì¶œ ë‚´ì—­</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>ë‚ ì§œ</th>
              <th>í”Œë«í¼</th>
              <th>ë§¤ì¶œì•¡</th>
              <th>ìˆ˜ìˆ˜ë£Œ</th>
              <th>ìˆœë§¤ì¶œ</th>
              <th>ë©”ëª¨</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody id="platform-sales-table">
            <tr><td colspan="7" class="loading">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ì°¨íŠ¸ íƒ­ -->
    <div id="tab-charts" class="tab-content">
      <div class="chart-container">
        <h3>ğŸ“Š ì¼ë³„ ë§¤ì¶œ ì¶”ì´</h3>
        <canvas id="daily-sales-chart"></canvas>
      </div>
      <div class="chart-container">
        <h3>ğŸ“Š ì±„ë„ë³„ ë§¤ì¶œ ë¹„êµ</h3>
        <canvas id="channel-comparison-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ë¡œê·¸ì¸ ì²´í¬
    if (sessionStorage.getItem('pos-authenticated') !== 'true') {
      window.location.href = '/pos/login.html';
    }

    let storeName = 'ì‹œí‹°ë°˜ì ';
    let charts = {};
    let currentStartDate = null;
    let currentEndDate = null;

    // ê°€ê²Œ ì •ë³´ ë¡œë“œ
    async function loadStoreInfo() {
      try {
        const res = await fetch('/api/store/info');
        const data = await res.json();
        if (data.success && data.storeInfo && data.storeInfo.name) {
          storeName = data.storeInfo.name;
          document.querySelectorAll('[data-store-name]').forEach(el => {
            el.textContent = `ğŸ® ${storeName}`;
          });
        }
      } catch (error) {
        console.error('ê°€ê²Œ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ë‚ ì§œ í•„í„° ì´ˆê¸°í™” (ì˜¤ëŠ˜ ë‚ ì§œë¡œ)
    function initDateFilter() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      document.getElementById('start-date').value = firstDay.toISOString().split('T')[0];
      document.getElementById('end-date').value = today.toISOString().split('T')[0];
    }

    // ë‚ ì§œ í•„í„° ë¦¬ì…‹
    function resetDateFilter() {
      document.getElementById('start-date').value = '';
      document.getElementById('end-date').value = '';
      currentStartDate = null;
      currentEndDate = null;
      loadStats();
    }

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      currentStartDate = startDate || null;
      currentEndDate = endDate || null;
      
      try {
        const params = new URLSearchParams();
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);
        
        const res = await fetch(`/api/sales/total?${params.toString()}`);
        const data = await res.json();
        
        if (data.success) {
          updateStats(data.stats);
          updatePlatformBreakdown(data.stats.platformBreakdown);
          if (charts.salesComposition) {
            charts.salesComposition.destroy();
          }
          renderSalesCompositionChart(data.stats);
        }
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(stats) {
      document.getElementById('stat-app-sales').textContent = stats.appSales.toLocaleString() + 'ì›';
      document.getElementById('stat-app-count').textContent = stats.appOrderCount + 'ê±´';
      document.getElementById('stat-hall-sales').textContent = stats.hallSales.toLocaleString() + 'ì›';
      document.getElementById('stat-hall-count').textContent = stats.hallSaleCount + 'ê±´';
      document.getElementById('stat-platform-sales').textContent = stats.platformSales.toLocaleString() + 'ì›';
      document.getElementById('stat-platform-count').textContent = stats.platformSaleCount + 'ê±´';
      document.getElementById('stat-total-sales').textContent = stats.totalSales.toLocaleString() + 'ì›';
      document.getElementById('stat-net-sales').textContent = stats.netSales.toLocaleString() + 'ì›';
      document.getElementById('stat-commission').textContent = stats.platformCommission.toLocaleString() + 'ì›';
    }

    // í”Œë«í¼ë³„ ë§¤ì¶œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updatePlatformBreakdown(breakdown) {
      const tbody = document.getElementById('platform-breakdown-table');
      const platformNames = {
        'baemin': 'ë°°ë‹¬ì˜ë¯¼ì¡±',
        'yogiyo': 'ìš”ê¸°ìš”',
        'coupang': 'ì¿ íŒ¡ì´ì¸ ',
        'shuttle': 'ë°°ë‹¬íŠ¹ê¸‰',
        'etc': 'ê¸°íƒ€'
      };
      
      if (!breakdown || Object.keys(breakdown).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      tbody.innerHTML = Object.entries(breakdown).map(([platform, data]) => {
        const netAmount = data.amount - data.commission;
        return `
          <tr>
            <td>${platformNames[platform] || platform}</td>
            <td>${data.amount.toLocaleString()}ì›</td>
            <td>${data.commission.toLocaleString()}ì›</td>
            <td>${netAmount.toLocaleString()}ì›</td>
            <td>${data.count}ê±´</td>
          </tr>
        `;
      }).join('');
    }

    // ë§¤ì¶œ êµ¬ì„± ì°¨íŠ¸
    function renderSalesCompositionChart(stats) {
      const ctx = document.getElementById('sales-composition-chart');
      if (!ctx) return;
      
      charts.salesComposition = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['ë°°ë‹¬ì•±', 'í™€', 'íƒ€ í”Œë«í¼'],
          datasets: [{
            data: [stats.appSales, stats.hallSales, stats.platformSales],
            backgroundColor: ['#1976d2', '#4caf50', '#ff9800'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value.toLocaleString()}ì› (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // í™€ ë§¤ì¶œ ë¡œë“œ
    async function loadHallSales() {
      try {
        const params = new URLSearchParams();
        if (currentStartDate) params.append('startDate', currentStartDate);
        if (currentEndDate) params.append('endDate', currentEndDate);
        
        const res = await fetch(`/api/sales/hall?${params.toString()}`);
        const data = await res.json();
        
        if (data.success) {
          renderHallSales(data.sales);
        }
      } catch (error) {
        console.error('í™€ ë§¤ì¶œ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // í™€ ë§¤ì¶œ ë Œë”ë§
    function renderHallSales(sales) {
      const tbody = document.getElementById('hall-sales-table');
      if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">ë§¤ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      tbody.innerHTML = sales.map(sale => {
        const date = new Date(sale.date).toLocaleDateString('ko-KR');
        const paymentNames = { cash: 'í˜„ê¸ˆ', card: 'ì¹´ë“œ', mixed: 'í˜¼í•©' };
        return `
          <tr>
            <td>${date}</td>
            <td>${sale.amount.toLocaleString()}ì›</td>
            <td>${paymentNames[sale.paymentMethod] || sale.paymentMethod}</td>
            <td>${sale.memo || '-'}</td>
            <td>
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="deleteHallSale(${sale.id})">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // íƒ€ í”Œë«í¼ ë§¤ì¶œ ë¡œë“œ
    async function loadPlatformSales() {
      try {
        const params = new URLSearchParams();
        if (currentStartDate) params.append('startDate', currentStartDate);
        if (currentEndDate) params.append('endDate', currentEndDate);
        
        const res = await fetch(`/api/sales/platform?${params.toString()}`);
        const data = await res.json();
        
        if (data.success) {
          renderPlatformSales(data.sales);
        }
      } catch (error) {
        console.error('íƒ€ í”Œë«í¼ ë§¤ì¶œ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // íƒ€ í”Œë«í¼ ë§¤ì¶œ ë Œë”ë§
    function renderPlatformSales(sales) {
      const tbody = document.getElementById('platform-sales-table');
      const platformNames = {
        'baemin': 'ë°°ë‹¬ì˜ë¯¼ì¡±',
        'yogiyo': 'ìš”ê¸°ìš”',
        'coupang': 'ì¿ íŒ¡ì´ì¸ ',
        'shuttle': 'ë°°ë‹¬íŠ¹ê¸‰',
        'etc': 'ê¸°íƒ€'
      };
      
      if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">ë§¤ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }
      
      tbody.innerHTML = sales.map(sale => {
        const date = new Date(sale.date).toLocaleDateString('ko-KR');
        const netAmount = sale.amount - (sale.commission || 0);
        return `
          <tr>
            <td>${date}</td>
            <td>${platformNames[sale.platform] || sale.platform}</td>
            <td>${sale.amount.toLocaleString()}ì›</td>
            <td>${(sale.commission || 0).toLocaleString()}ì›</td>
            <td>${netAmount.toLocaleString()}ì›</td>
            <td>${sale.memo || '-'}</td>
            <td>
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="deletePlatformSale(${sale.id})">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // í™€ ë§¤ì¶œ ë“±ë¡
    document.getElementById('hall-sale-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const saleData = {
        date: document.getElementById('hall-date').value,
        amount: parseInt(document.getElementById('hall-amount').value),
        paymentMethod: document.getElementById('hall-payment').value,
        memo: document.getElementById('hall-memo').value
      };
      
      try {
        const res = await fetch('/api/sales/hall', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(saleData)
        });
        
        const data = await res.json();
        if (data.success) {
          alert('í™€ ë§¤ì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
          document.getElementById('hall-sale-form').reset();
          loadStats();
          loadHallSales();
        } else {
          alert('ë“±ë¡ ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
      }
    });

    // íƒ€ í”Œë«í¼ ë§¤ì¶œ ë“±ë¡
    document.getElementById('platform-sale-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const saleData = {
        platform: document.getElementById('platform-name').value,
        date: document.getElementById('platform-date').value,
        amount: parseInt(document.getElementById('platform-amount').value),
        commission: parseInt(document.getElementById('platform-commission').value) || 0,
        paymentMethod: document.getElementById('platform-payment').value,
        memo: document.getElementById('platform-memo').value
      };
      
      try {
        const res = await fetch('/api/sales/platform', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(saleData)
        });
        
        const data = await res.json();
        if (data.success) {
          alert('íƒ€ í”Œë«í¼ ë§¤ì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
          document.getElementById('platform-sale-form').reset();
          loadStats();
          loadPlatformSales();
        } else {
          alert('ë“±ë¡ ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
      }
    });

    // í™€ ë§¤ì¶œ ì‚­ì œ
    async function deleteHallSale(id) {
      if (!confirm('ì´ ë§¤ì¶œ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const res = await fetch(`/api/sales/hall/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
          loadStats();
          loadHallSales();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
      }
    }

    // íƒ€ í”Œë«í¼ ë§¤ì¶œ ì‚­ì œ
    async function deletePlatformSale(id) {
      if (!confirm('ì´ ë§¤ì¶œ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const res = await fetch(`/api/sales/platform/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
          loadStats();
          loadPlatformSales();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì˜¤ë¥˜: ' + error.message);
      }
    }

    // íƒ­ ì „í™˜
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      if (tabName === 'hall') {
        loadHallSales();
      } else if (tabName === 'platform') {
        loadPlatformSales();
      } else if (tabName === 'charts') {
        renderCharts();
      }
    }

    // ì°¨íŠ¸ ë Œë”ë§
    async function renderCharts() {
      // ì¼ë³„ ë§¤ì¶œ ì¶”ì´ ì°¨íŠ¸
      const dailyCtx = document.getElementById('daily-sales-chart');
      if (dailyCtx && !charts.dailySales) {
        // TODO: ì¼ë³„ ë°ì´í„° ë¡œë“œ ë° ì°¨íŠ¸ ìƒì„±
      }
      
      // ì±„ë„ë³„ ë¹„êµ ì°¨íŠ¸
      const channelCtx = document.getElementById('channel-comparison-chart');
      if (channelCtx && !charts.channelComparison) {
        // TODO: ì±„ë„ë³„ ë¹„êµ ì°¨íŠ¸ ìƒì„±
      }
    }

    // ì‚¬ì´ë“œ ë©”ë‰´ í† ê¸€
    function toggleMenu() {
      const sideMenu = document.getElementById('side-menu');
      const overlay = document.getElementById('menu-overlay');
      sideMenu.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ì‚¬ì´íŠ¸ í¸ì§‘ ëª¨ë“œ ì—´ê¸°
    function openSiteEditor() {
      const editWindow = window.open('/pos/site-editor.html', 'siteEditor', 'width=1600,height=1000,scrollbars=yes,resizable=yes');
      if (editWindow) {
        editWindow.focus();
      } else {
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
      }
    }

    // ì£¼ë¬¸ ì†Œë¦¬ í¬ê¸° ì„¤ì • íŒì—… ì—´ê¸°
    function openVolumeSettings() {
      alert('ì£¼ë¬¸ ì†Œë¦¬ í¬ê¸° ì„¤ì •ì€ ì£¼ë¬¸ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }

    // ì´ˆê¸°í™”
    loadStoreInfo();
    initDateFilter();
    loadStats();
  </script>
</body>
</html>

