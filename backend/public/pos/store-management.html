<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°€ê²Œ ê´€ë¦¬ - ì‹œí‹°ë°˜ì  POS</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .store-management-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 30px;
    }
    .page-header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .page-header h2 {
      font-size: 1.8em;
      color: #1976d2;
      margin: 0;
    }
    .section-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    @media (max-width: 768px) {
      .store-management-container {
        padding: 15px;
      }
      
      .page-header {
        margin-bottom: 20px;
      }
      
      .page-header h2 {
        font-size: 1.4em;
      }
      
      .section-card {
        padding: 20px;
        margin-bottom: 15px;
      }
      
      .section-title {
        font-size: 1.2em;
        margin-bottom: 15px;
      }
      
      .form-group {
        margin-bottom: 12px;
      }
      
      .form-group input,
      .form-group select {
        font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
        padding: 12px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .time-settings-table {
        font-size: 13px;
      }
      
      .time-settings-table th,
      .time-settings-table td {
        padding: 10px 8px;
      }
      
      .time-settings-table input {
        width: 100%;
        padding: 8px;
        font-size: 14px;
      }
      
      .btn-save {
        width: 100%;
        padding: 12px;
        font-size: 15px;
      }
      
      .day-row,
      .break-time-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .day-name {
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .store-management-container {
        padding: 10px;
      }
      
      .page-header h2 {
        font-size: 1.2em;
      }
      
      .section-card {
        padding: 15px;
      }
      
      .section-title {
        font-size: 1.1em;
      }
      
      .time-settings-table {
        font-size: 12px;
      }
      
      .time-settings-table th,
      .time-settings-table td {
        padding: 8px 6px;
      }
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #1976d2;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .btn-save {
      background: #4caf50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-save:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4caf50;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .business-hours-grid {
      display: grid;
      gap: 15px;
      margin-top: 15px;
    }
    .day-row {
      display: grid;
      grid-template-columns: 100px 1fr 1fr;
      gap: 15px;
      align-items: center;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .day-name {
      font-weight: 600;
      color: #333;
    }
    .time-input {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .time-input input {
      flex: 1;
    }
    .break-time-row {
      display: grid;
      grid-template-columns: 100px 1fr 1fr;
      gap: 15px;
      align-items: center;
      padding: 10px 15px;
      background: #fff3e0;
      border-radius: 6px;
      margin-top: 8px;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }
    .status-open {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status-closed {
      background: #ffebee;
      color: #c62828;
    }
    .status-break {
      background: #fff3e0;
      color: #e65100;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1 data-store-name>ğŸ® ì‹œí‹°ë°˜ì </h1>
    </div>
    <div class="header-controls">
      <a href="/pos" style="color: white; text-decoration: none; padding: 8px 14px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 13px;">â† ì£¼ë¬¸ ê´€ë¦¬</a>
    </div>
  </div>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
  <div class="side-menu" id="side-menu">
    <div class="side-menu-header">
      <h2>ğŸ“Š ë©”ë‰´</h2>
      <button class="close-btn" onclick="toggleMenu()">âœ•</button>
    </div>
    <nav class="side-menu-nav">
      <a href="/pos" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“‹</span>
        <span class="menu-text">ì „ì²´í˜„í™©Â·ì„ì‹œì¤‘ì§€</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/store-management.html" class="menu-item active" onclick="toggleMenu()">
        <span class="menu-icon">ğŸª</span>
        <span class="menu-text">ê°€ê²Œê´€ë¦¬</span>
      </a>
      <a href="/pos/dashboard.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“Š</span>
        <span class="menu-text">ê°€ê²Œí†µê³„</span>
        <span class="menu-badge">ì—…ë°ì´íŠ¸</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/menu-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“</span>
        <span class="menu-text">ê°€ê²Œ ë©”ë‰´íŒ í¸ì§‘</span>
      </a>
      <a href="/pos/menu-management.html?tab=options" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">âš™ï¸</span>
        <span class="menu-text">ë©”ë‰´Â·ì˜µì…˜ ê´€ë¦¬</span>
      </a>
      <a href="/pos/menu-management.html?tab=discounts" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ·ï¸</span>
        <span class="menu-text">ë©”ë‰´ë³„ í• ì¸ ê´€ë¦¬</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/dashboard.html?tab=settlement" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ’°</span>
        <span class="menu-text">ì •ì‚° ì •ë³´</span>
      </a>
      <a href="/pos/dashboard.html?tab=customers" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ‘¥</span>
        <span class="menu-text">ê³ ê° ë¶„ì„</span>
      </a>
      <a href="/pos/dashboard.html?tab=regions" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“</span>
        <span class="menu-text">ì§€ì—­ ë¶„ì„</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/point-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ’°</span>
        <span class="menu-text">í¬ì¸íŠ¸ ê´€ë¦¬</span>
      </a>
      <a href="/pos/coupon-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ«</span>
        <span class="menu-text">ì¿ í° ê´€ë¦¬</span>
      </a>
      <a href="/pos/total-sales-management.html" class="menu-item" onclick="toggleMenu()">
        <span class="menu-icon">ğŸ“ˆ</span>
        <span class="menu-text">í†µí•© ë§¤ì¶œ ê´€ë¦¬</span>
      </a>
      <div class="menu-divider"></div>
      <a href="javascript:void(0)" class="menu-item" onclick="openSiteEditor(); toggleMenu();">
        <span class="menu-icon">ğŸ¨</span>
        <span class="menu-text">ì‚¬ì´íŠ¸ ë””ìì¸ í¸ì§‘</span>
      </a>
      <div class="menu-divider"></div>
      <a href="/pos/login.html" class="menu-item" onclick="sessionStorage.removeItem('pos-authenticated'); toggleMenu();">
        <span class="menu-icon">ğŸšª</span>
        <span class="menu-text">ë¡œê·¸ì•„ì›ƒ</span>
      </a>
    </nav>
  </div>
  
  <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>

  <div class="store-management-container">
    <div class="page-header">
      <h2>ğŸª ê°€ê²Œ ê´€ë¦¬</h2>
      <button class="btn-add" onclick="openSiteEditor()" style="background: #9c27b0; margin-left: auto;">ğŸ¨ ì‚¬ì´íŠ¸ í¸ì§‘ ëª¨ë“œ</button>
    </div>

    <!-- ê°€ê²Œ ì •ë³´ -->
    <div class="section-card">
      <div class="section-title">ğŸ“ ê°€ê²Œ ì •ë³´</div>
      <form id="store-info-form">
        <div class="form-group">
          <label>ê°€ê²Œëª…</label>
          <input type="text" id="store-name" value="ì‹œí‹°ë°˜ì " placeholder="ê°€ê²Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
          <label>ëŒ€í‘œìëª…</label>
          <input type="text" id="store-owner" value="" placeholder="ëŒ€í‘œìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ì „í™”ë²ˆí˜¸</label>
            <input type="tel" id="store-phone" value="031-123-4567" placeholder="031-123-4567">
          </div>
          <div class="form-group">
            <label>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
            <input type="text" id="store-license" value="" placeholder="123-45-67890">
          </div>
        </div>
        <div class="form-group">
          <label>ì£¼ì†Œ</label>
          <input type="text" id="store-address" value="ê²½ê¸°ë„ ì•ˆì„±ì‹œ ê³µë„ì" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
          <label>ì¹´ì¹´ì˜¤í†¡ ì±„ë„ URL</label>
          <input type="url" id="store-kakao-url" value="" placeholder="https://pf.kakao.com/_xxxxx">
          <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ê´€ë¦¬ìì—ì„œ ì±„ë„ URLì„ ë³µì‚¬í•´ ì…ë ¥í•˜ì„¸ìš”</small>
        </div>
        <div class="form-group">
          <label>ì‹¤ì‹œê°„ ì±„íŒ… ì„œë¹„ìŠ¤ URL</label>
          <input type="url" id="store-chat-url" value="" placeholder="https://your-chat-service.com/widget">
          <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">ë‚˜ì¤‘ì— ì™¸ë¶€ ì±„íŒ… ì„œë¹„ìŠ¤ ì—°ë™ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤</small>
        </div>
        <button type="button" class="btn-save" onclick="saveStoreInfo()">ê°€ê²Œ ì •ë³´ ì €ì¥</button>
      </form>
    </div>

    <!-- ì˜ì—… ìƒíƒœ -->
    <div class="section-card">
      <div class="section-title">ğŸŸ¢ ì˜ì—… ìƒíƒœ</div>
      <div class="form-group">
        <div class="toggle-switch">
          <label class="switch">
            <input type="checkbox" id="temporary-closed-toggle" onchange="toggleTemporaryClosed()">
            <span class="slider"></span>
          </label>
          <span id="temporary-closed-text" style="font-weight: 600;">ì„ì‹œíœ´ì—…</span>
        </div>
        <div id="current-status" style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 8px;">í˜„ì¬ ìƒíƒœ</div>
          <div id="status-display">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- ì˜ì—…ì‹œê°„ ì„¤ì • -->
    <div class="section-card">
      <div class="section-title">â° ì˜ì—…ì‹œê°„ ì„¤ì •</div>
      <div class="business-hours-grid" id="business-hours-grid">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
      <button type="button" class="btn-save" onclick="saveBusinessHours()" style="margin-top: 20px;">ì˜ì—…ì‹œê°„ ì €ì¥</button>
    </div>

    <!-- ë¸Œë ˆì´í¬íƒ€ì„ ì„¤ì • -->
    <div class="section-card">
      <div class="section-title">â˜• ë¸Œë ˆì´í¬íƒ€ì„ ì„¤ì •</div>
      <div class="business-hours-grid" id="break-time-grid">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
      <button type="button" class="btn-save" onclick="saveBreakTime()" style="margin-top: 20px;">ë¸Œë ˆì´í¬íƒ€ì„ ì €ì¥</button>
    </div>

    <!-- ìš”ì¼ë³„ íœ´ë¬´ì¼ ì„¤ì • -->
    <div class="section-card">
      <div class="section-title">ğŸš« ìš”ì¼ë³„ íœ´ë¬´ì¼ ì„¤ì •</div>
      <div class="business-hours-grid" id="closed-days-grid">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
      <button type="button" class="btn-save" onclick="saveClosedDays()" style="margin-top: 20px;">íœ´ë¬´ì¼ ì €ì¥</button>
    </div>
  </div>

  <script>
    // Check authentication
    if (sessionStorage.getItem('pos-authenticated') !== 'true') {
      window.location.href = 'login.html';
    }

    let businessHours = {};
    let breakTime = {};
    let temporaryClosed = false;
    let closedDays = []; // íœ´ë¬´ì¼ ë°°ì—´ (0=ì¼ìš”ì¼, 6=í† ìš”ì¼)

    const dayNames = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];

    // ì‚¬ì´ë“œ ë©”ë‰´ í† ê¸€
    function toggleMenu() {
      const sideMenu = document.getElementById('side-menu');
      const overlay = document.getElementById('menu-overlay');
      sideMenu.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // ì˜ì—…ì‹œê°„ ë¡œë“œ
    async function loadBusinessHours() {
      try {
        const res = await fetch('/api/business-hours');
        const data = await res.json();
        console.log('ğŸ“¥ ì˜ì—…ì‹œê°„ ë¡œë“œ ì‘ë‹µ:', data);
        
        if (data.allBusinessHours && Object.keys(data.allBusinessHours).length > 0) {
          // ìš”ì¼ë³„ ì˜ì—…ì‹œê°„ì´ ìˆìœ¼ë©´ ì‚¬ìš©
          businessHours = data.allBusinessHours;
          console.log('âœ… ìš”ì¼ë³„ ì˜ì—…ì‹œê°„ ë¡œë“œ:', businessHours);
        } else if (data.businessHours) {
          // ê¸°ë³¸ ì˜ì—…ì‹œê°„ë§Œ ìˆëŠ” ê²½ìš°
          businessHours = {};
          console.log('âš ï¸ ìš”ì¼ë³„ ì˜ì—…ì‹œê°„ ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
        } else {
          businessHours = {};
        }
        
        temporaryClosed = data.temporaryClosed || false;
        breakTime = data.allBreakTime || data.breakTime || {};
        closedDays = data.closedDays || [];
        
        renderBusinessHours();
        renderBreakTime();
        renderClosedDays();
        updateStatus();
        updateTemporaryClosedToggle();
      } catch (error) {
        console.error('âŒ ì˜ì—…ì‹œê°„ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ì˜ì—…ì‹œê°„ ë Œë”ë§
    function renderBusinessHours() {
      const container = document.getElementById('business-hours-grid');
      container.innerHTML = '';
      
      for (let day = 0; day <= 6; day++) {
        const hours = businessHours[day] || { open: 9.5, close: 21 };
        const openHour = Math.floor(hours.open);
        const openMin = Math.round((hours.open - openHour) * 60);
        const closeHour = Math.floor(hours.close);
        const closeMin = Math.round((hours.close - closeHour) * 60);
        
        container.innerHTML += `
          <div class="day-row">
            <div class="day-name">${dayNames[day]}</div>
            <div class="time-input">
              <label>ì˜¤í”ˆ</label>
              <input type="time" data-day="${day}" data-type="open" value="${String(openHour).padStart(2, '0')}:${String(openMin).padStart(2, '0')}">
            </div>
            <div class="time-input">
              <label>ë§ˆê°</label>
              <input type="time" data-day="${day}" data-type="close" value="${String(closeHour).padStart(2, '0')}:${String(closeMin).padStart(2, '0')}">
            </div>
          </div>
        `;
      }
    }

    // ë¸Œë ˆì´í¬íƒ€ì„ ë Œë”ë§
    function renderBreakTime() {
      const container = document.getElementById('break-time-grid');
      container.innerHTML = '';
      
      for (let day = 0; day <= 6; day++) {
        const bt = breakTime[day];
        const startHour = bt ? Math.floor(bt.start) : 0;
        const startMin = bt ? Math.round((bt.start - startHour) * 60) : 0;
        const endHour = bt ? Math.floor(bt.end) : 0;
        const endMin = bt ? Math.round((bt.end - endHour) * 60) : 0;
        
        container.innerHTML += `
          <div class="day-row">
            <div class="day-name">${dayNames[day]}</div>
            <div class="time-input">
              <label>ì‹œì‘</label>
              <input type="time" data-day="${day}" data-type="start" value="${bt ? String(startHour).padStart(2, '0') + ':' + String(startMin).padStart(2, '0') : ''}" placeholder="ì„¤ì • ì•ˆí•¨">
            </div>
            <div class="time-input">
              <label>ì¢…ë£Œ</label>
              <input type="time" data-day="${day}" data-type="end" value="${bt ? String(endHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0') : ''}" placeholder="ì„¤ì • ì•ˆí•¨">
            </div>
          </div>
        `;
      }
    }

    // íœ´ë¬´ì¼ ë Œë”ë§
    function renderClosedDays() {
      const container = document.getElementById('closed-days-grid');
      container.innerHTML = '';
      
      for (let day = 0; day <= 6; day++) {
        const isClosed = closedDays.includes(day);
        container.innerHTML += `
          <div class="day-row">
            <div class="day-name">${dayNames[day]}</div>
            <div class="toggle-switch" style="grid-column: 2 / 4;">
              <label class="switch">
                <input type="checkbox" data-day="${day}" ${isClosed ? 'checked' : ''} onchange="updateClosedDay(${day})">
                <span class="slider"></span>
              </label>
              <span style="font-weight: 600; color: ${isClosed ? '#f44336' : '#4caf50'};">
                ${isClosed ? 'ğŸš« íœ´ë¬´' : 'ğŸŸ¢ ì˜ì—…'}
              </span>
            </div>
          </div>
        `;
      }
    }

    // íœ´ë¬´ì¼ ì—…ë°ì´íŠ¸
    function updateClosedDay(day) {
      const checkbox = document.querySelector(`input[data-day="${day}"]`);
      const isClosed = checkbox.checked;
      
      if (isClosed) {
        if (!closedDays.includes(day)) {
          closedDays.push(day);
        }
      } else {
        closedDays = closedDays.filter(d => d !== day);
      }
      
      renderClosedDays();
    }

    // íœ´ë¬´ì¼ ì €ì¥
    async function saveClosedDays() {
      try {
        const res = await fetch('/api/closed-days', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ closedDays })
        });
        
        const data = await res.json();
        console.log('ğŸ“¥ íœ´ë¬´ì¼ ì €ì¥ ì‘ë‹µ:', data);
        
        if (data.success) {
          alert('íœ´ë¬´ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          updateStatus();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('âŒ íœ´ë¬´ì¼ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ì˜ì—…ì‹œê°„ ì €ì¥
    async function saveBusinessHours() {
      const hours = {};
      
      // ëª¨ë“  ìš”ì¼(0-6)ì— ëŒ€í•´ openê³¼ closeë¥¼ ëª¨ë‘ ìˆ˜ì§‘
      for (let day = 0; day <= 6; day++) {
        const openInput = document.querySelector(`#business-hours-grid input[data-day="${day}"][data-type="open"]`);
        const closeInput = document.querySelector(`#business-hours-grid input[data-day="${day}"][data-type="close"]`);
        
        if (openInput && closeInput && openInput.value && closeInput.value) {
          const [openH, openM] = openInput.value.split(':').map(Number);
          const [closeH, closeM] = closeInput.value.split(':').map(Number);
          
          hours[day] = {
            open: openH + openM / 60,
            close: closeH + closeM / 60
          };
        }
      }
      
      console.log('ğŸ“ ì €ì¥í•  ì˜ì—…ì‹œê°„ ë°ì´í„°:', hours);

      try {
        const res = await fetch('/api/business-hours', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hours })
        });
        
        const data = await res.json();
        console.log('ğŸ“¥ ì„œë²„ ì‘ë‹µ:', data);
        
        if (data.success) {
          alert('ì˜ì—…ì‹œê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          // ì €ì¥ëœ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if (data.allBusinessHours) {
            businessHours = data.allBusinessHours;
          } else {
            businessHours = hours;
          }
          // ì˜ì—…ì‹œê°„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ í™”ë©´ ê°±ì‹ 
          await loadBusinessHours();
          updateStatus();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('âŒ ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ë¸Œë ˆì´í¬íƒ€ì„ ì €ì¥
    async function saveBreakTime() {
      const breakTimes = {};
      
      for (let day = 0; day <= 6; day++) {
        const startInput = document.querySelector(`#break-time-grid input[data-day="${day}"][data-type="start"]`);
        const endInput = document.querySelector(`#break-time-grid input[data-day="${day}"][data-type="end"]`);
        
        if (startInput.value && endInput.value) {
          const [sh, sm] = startInput.value.split(':').map(Number);
          const [eh, em] = endInput.value.split(':').map(Number);
          breakTimes[day] = {
            start: sh + sm / 60,
            end: eh + em / 60
          };
        }
      }

      try {
        const res = await fetch('/api/break-time', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ breakTimes })
        });
        const data = await res.json();
        if (data.success) {
          alert('ë¸Œë ˆì´í¬íƒ€ì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          breakTime = breakTimes;
          updateStatus();
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ì„ì‹œíœ´ì—… í† ê¸€
    async function toggleTemporaryClosed() {
      const checked = document.getElementById('temporary-closed-toggle').checked;
      
      try {
        const res = await fetch('/api/temporary-closed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ closed: checked })
        });
        const data = await res.json();
        if (data.success) {
          temporaryClosed = checked;
          updateStatus();
          updateTemporaryClosedToggle();
        } else {
          alert('ì„¤ì • ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì„¤ì • ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ì„ì‹œíœ´ì—… í† ê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateTemporaryClosedToggle() {
      document.getElementById('temporary-closed-toggle').checked = temporaryClosed;
      document.getElementById('temporary-closed-text').textContent = temporaryClosed ? 'ì„ì‹œíœ´ì—… ì¤‘' : 'ì˜ì—… ì¤‘';
    }

    // í˜„ì¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus() {
      const now = new Date();
      const koreaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
      const dayOfWeek = koreaTime.getDay();
      const hour = koreaTime.getHours();
      const minute = koreaTime.getMinutes();
      const currentTime = hour + minute / 60;

      let statusText = '';
      let statusClass = '';

      if (temporaryClosed) {
        statusText = 'ì„ì‹œíœ´ì—… ì¤‘';
        statusClass = 'status-closed';
      } else if (closedDays.includes(dayOfWeek)) {
        statusText = 'íœ´ë¬´ì¼';
        statusClass = 'status-closed';
      } else {
        const todayHours = businessHours[dayOfWeek];
        const todayBreakTime = breakTime[dayOfWeek];
        
        if (!todayHours || currentTime < todayHours.open || currentTime >= todayHours.close) {
          statusText = 'ì˜ì—…ì‹œê°„ ì™¸';
          statusClass = 'status-closed';
        } else if (todayBreakTime && currentTime >= todayBreakTime.start && currentTime < todayBreakTime.end) {
          statusText = 'ë¸Œë ˆì´í¬íƒ€ì„ ì¤‘';
          statusClass = 'status-break';
        } else {
          statusText = 'ì˜ì—… ì¤‘';
          statusClass = 'status-open';
        }
      }

      const formatTime = (time) => {
        const h = Math.floor(time);
        const m = Math.round((time - h) * 60);
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      };

      const todayHours = businessHours[dayOfWeek] || { open: 9.5, close: 21 };
      const statusDisplay = document.getElementById('status-display');
      statusDisplay.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <span class="status-badge ${statusClass}">${statusText}</span>
          <span style="color: #666;">${dayNames[dayOfWeek]} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}</span>
        </div>
        <div style="color: #666; font-size: 14px;">
          ì˜¤ëŠ˜ ì˜ì—…ì‹œê°„: ${formatTime(todayHours.open)} - ${formatTime(todayHours.close)}
        </div>
      `;
    }

    // ê°€ê²Œ ì •ë³´ ë¡œë“œ
    async function loadStoreInfo() {
      try {
        const res = await fetch('/api/store/info');
        const data = await res.json();
        if (data.success && data.storeInfo) {
          document.getElementById('store-name').value = data.storeInfo.name || 'ì‹œí‹°ë°˜ì ';
          document.getElementById('store-owner').value = data.storeInfo.owner || '';
          document.getElementById('store-phone').value = data.storeInfo.phone || '';
          document.getElementById('store-license').value = data.storeInfo.license || '';
          document.getElementById('store-address').value = data.storeInfo.address || '';
          document.getElementById('store-kakao-url').value = data.storeInfo.kakaoChannelUrl || '';
          document.getElementById('store-chat-url').value = data.storeInfo.chatServiceUrl || '';
        }
      } catch (error) {
        console.error('ê°€ê²Œ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ê°€ê²Œ ì •ë³´ ì €ì¥
    async function saveStoreInfo() {
      const storeInfo = {
        name: document.getElementById('store-name').value,
        owner: document.getElementById('store-owner').value,
        phone: document.getElementById('store-phone').value,
        license: document.getElementById('store-license').value,
        address: document.getElementById('store-address').value,
        kakaoChannelUrl: document.getElementById('store-kakao-url').value,
        chatServiceUrl: document.getElementById('store-chat-url').value
      };

      try {
        const res = await fetch('/api/store/info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(storeInfo)
        });
        const data = await res.json();
        if (data.success) {
          alert('ê°€ê²Œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë“  í˜ì´ì§€ì— ë°˜ì˜ë©ë‹ˆë‹¤.');
          // í‘¸í„° ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì´ë²¤íŠ¸ ë°œìƒ
          window.dispatchEvent(new CustomEvent('store-info-updated'));
        } else {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
        }
      } catch (error) {
        alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message);
      }
    }

    // ì‚¬ì´íŠ¸ í¸ì§‘ ëª¨ë“œ ì—´ê¸°
    function openSiteEditor() {
      const editWindow = window.open('/pos/site-editor.html', 'siteEditor', 'width=1600,height=1000,scrollbars=yes,resizable=yes');
      if (editWindow) {
        editWindow.focus();
      } else {
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
      }
    }

    // íœ´ë¬´ì¼ ë¡œë“œ
    async function loadClosedDays() {
      try {
        const res = await fetch('/api/closed-days');
        const data = await res.json();
        if (data.success) {
          closedDays = data.closedDays || [];
          renderClosedDays();
        }
      } catch (error) {
        console.error('âŒ íœ´ë¬´ì¼ ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ì´ˆê¸°í™”
    loadStoreInfo();
    loadBusinessHours();
    loadClosedDays();
    setInterval(updateStatus, 60000); // 1ë¶„ë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  </script>
</body>
</html>

