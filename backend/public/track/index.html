<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë¬¸ ì¡°íšŒ - ì‹œí‹°ë°˜ì </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .search-box {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #d32f2f;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
    }

    .tab-btn {
      padding: 10px 20px;
      margin: 0 5px;
      border: 2px solid #d32f2f;
      background: white;
      color: #d32f2f;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: #d32f2f;
      color: white;
    }

    .tab-btn:hover {
      transform: translateY(-2px);
    }

    .order-result {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: none;
    }

    .order-result.show {
      display: block;
    }

    .order-id {
      font-size: 1.5em;
      font-weight: 700;
      color: #d32f2f;
      margin-bottom: 20px;
      font-family: monospace;
    }

    .status-tracker {
      margin: 30px 0;
    }

    .status-step {
      display: flex;
      align-items: center;
      margin: 15px 0;
      position: relative;
    }

    .status-step::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 40px;
      width: 2px;
      height: 50px;
      background: #e0e0e0;
    }

    .status-step:last-child::before {
      display: none;
    }

    .status-step.active::before {
      background: #4caf50;
    }

    .status-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 16px;
      flex-shrink: 0;
    }

    .status-step.active .status-icon {
      background: #4caf50;
      color: white;
    }
    
    .status-step.active .status-icon::before {
      content: 'âœ“';
      font-size: 18px;
      font-weight: bold;
    }

    .status-step.current .status-icon {
      background: #ffa000;
      color: white;
      animation: pulse 2s infinite;
      font-weight: bold;
    }
    
    .status-step.current .status-icon::before {
      content: 'â—';
      font-size: 14px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    .status-step.active .status-info h3 {
      color: #4caf50;
      font-weight: 700;
    }
    
    .status-step.current .status-info h3 {
      color: #ffa000;
      font-weight: 800;
    }

    .status-info h3 {
      font-size: 1.1em;
      margin-bottom: 5px;
      color: #333;
    }

    .status-info p {
      color: #666;
      font-size: 0.9em;
    }

    .order-details {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #f0f0f0;
    }

    .order-details h3 {
      margin-bottom: 15px;
      color: #d32f2f;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .error-message {
      background: #ffebee;
      color: #d32f2f;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button onclick="history.back()" style="background: #757575; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">â† ë’¤ë¡œ</button>
        <button onclick="location.href='/order-new'" style="background: #d32f2f; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">ğŸ  í™ˆ</button>
      </div>
      <h1>ğŸ® ì£¼ë¬¸ ì¡°íšŒ</h1>
      <p>ì£¼ë¬¸ë²ˆí˜¸ë¡œ ë°°ë‹¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <div class="search-box">
      <div style="margin-bottom: 20px; text-align: center;">
        <button type="button" class="tab-btn active" onclick="showTab('order-id')">ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒ</button>
        <button type="button" class="tab-btn" onclick="showTab('phone')">ì „í™”ë²ˆí˜¸ë¡œ ì¡°íšŒ</button>
      </div>

      <form id="search-form-orderid" class="search-form">
        <div class="form-group">
          <label>ì£¼ë¬¸ë²ˆí˜¸</label>
          <input type="text" id="order-id-input" placeholder="ORD-1234567890" required>
        </div>
        <button type="submit" class="btn">ì¡°íšŒí•˜ê¸°</button>
      </form>

      <form id="search-form-phone" class="search-form" style="display: none;">
        <div class="form-group">
          <label>ì „í™”ë²ˆí˜¸</label>
          <input type="tel" id="phone-input" placeholder="010-1234-5678" required>
        </div>
        <button type="submit" class="btn">ìµœê·¼ ì£¼ë¬¸ ì¡°íšŒ</button>
      </form>
      
      <div class="error-message" id="error-message">ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="order-result" id="order-result">
      <div class="order-id" id="display-order-id"></div>

      <div class="status-tracker" id="status-tracker">
        <div class="status-step" data-status="pending">
          <div class="status-icon"></div>
          <div class="status-info">
            <h3>ğŸ“ ì£¼ë¬¸ ì ‘ìˆ˜</h3>
            <p>ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</p>
          </div>
        </div>

        <div class="status-step" data-status="preparing">
          <div class="status-icon"></div>
          <div class="status-info">
            <h3>ğŸ‘¨â€ğŸ³ ì¡°ë¦¬ì¤‘</h3>
            <p>ë§›ìˆê²Œ ì¡°ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
          </div>
        </div>

        <div class="status-step" data-status="delivering">
          <div class="status-icon"></div>
          <div class="status-info">
            <h3>ğŸšš ë°°ë‹¬ì¤‘</h3>
            <p>ë°°ë‹¬ì›ì´ ì¶œë°œí–ˆìŠµë‹ˆë‹¤</p>
          </div>
        </div>

        <div class="status-step" data-status="completed">
          <div class="status-icon"></div>
          <div class="status-info">
            <h3>âœ¨ ë°°ë‹¬ ì™„ë£Œ</h3>
            <p>ë§›ìˆê²Œ ë“œì„¸ìš”!</p>
          </div>
        </div>
      </div>

      <div class="order-details" id="order-details"></div>

      <!-- ë¼ì´ë” ìœ„ì¹˜ ì§€ë„ -->
      <div id="rider-map-container" style="display: none; margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #d32f2f;">ğŸšš ë°°ë‹¬ì› ìœ„ì¹˜</h3>
        <div id="rider-map" style="width: 100%; height: 300px; border-radius: 10px; overflow: hidden;"></div>
        <div id="estimated-time" style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: center;">
          <p style="color: #1976d2; font-weight: 600; margin: 0;">ì˜ˆìƒ ë„ì°© ì‹œê°„: <span id="time-value">-</span>ë¶„</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // URLì—ì„œ orderId íŒŒë¼ë¯¸í„° í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const orderIdParam = urlParams.get('orderId');
    
    // sessionStorageì—ì„œ ìµœê·¼ ì£¼ë¬¸ë²ˆí˜¸ í™•ì¸ (ë¹„íšŒì› ì£¼ë¬¸ì¡°íšŒìš©)
    const lastOrderId = sessionStorage.getItem('lastOrderId');
    const lastOrderPhone = sessionStorage.getItem('lastOrderPhone');
    
    window.addEventListener('DOMContentLoaded', () => {
      // URL íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (orderIdParam) {
        document.getElementById('order-id-input').value = orderIdParam;
        document.getElementById('search-form-orderid').dispatchEvent(new Event('submit'));
      } 
      // sessionStorageì— ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ìë™ ì¡°íšŒ
      else if (lastOrderId) {
        document.getElementById('order-id-input').value = lastOrderId;
        if (lastOrderPhone) {
          document.getElementById('phone-input').value = lastOrderPhone;
        }
        // ìë™ìœ¼ë¡œ ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒ
        document.getElementById('search-form-orderid').dispatchEvent(new Event('submit'));
      }
    });
  </script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_APP_KEY&autoload=false"></script>
  <script>
    const socket = io();
    let currentOrderId = null;
    let map = null;
    let riderMarker = null;
    let destinationMarker = null;

    // íƒ­ ì „í™˜
    function showTab(tab) {
      const tabs = document.querySelectorAll('.tab-btn');
      const forms = document.querySelectorAll('.search-form');
      
      tabs.forEach(t => t.classList.remove('active'));
      forms.forEach(f => f.style.display = 'none');
      
      if (tab === 'order-id') {
        tabs[0].classList.add('active');
        document.getElementById('search-form-orderid').style.display = 'block';
      } else {
        tabs[1].classList.add('active');
        document.getElementById('search-form-phone').style.display = 'block';
      }
    }

    // ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒ
    document.getElementById('search-form-orderid').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const orderId = document.getElementById('order-id-input').value.trim();
      
      try {
        const res = await fetch(`/api/orders/${orderId}`);
        const data = await res.json();
        
        if (data.success) {
          currentOrderId = orderId;
          displayOrder(data.order);
          document.getElementById('error-message').classList.remove('show');
          document.getElementById('order-result').classList.add('show');
        } else {
          document.getElementById('error-message').textContent = 'ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          document.getElementById('error-message').classList.add('show');
          document.getElementById('order-result').classList.remove('show');
        }
      } catch (err) {
        alert('ì¡°íšŒ ì˜¤ë¥˜: ' + err.message);
      }
    });

    // ì „í™”ë²ˆí˜¸ë¡œ ì¡°íšŒ
    document.getElementById('search-form-phone').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const phone = document.getElementById('phone-input').value.trim();
      
      try {
        const res = await fetch(`/api/orders/phone/${encodeURIComponent(phone)}`);
        const data = await res.json();
        
        if (data.success && data.orders && data.orders.length > 0) {
          // ìµœê·¼ ì£¼ë¬¸ í‘œì‹œ
          const recentOrder = data.orders[0];
          currentOrderId = recentOrder.orderid || recentOrder.orderId;
          displayOrder(recentOrder);
          document.getElementById('error-message').classList.remove('show');
          document.getElementById('order-result').classList.add('show');
        } else {
          document.getElementById('error-message').textContent = 'í•´ë‹¹ ì „í™”ë²ˆí˜¸ë¡œ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
          document.getElementById('error-message').classList.add('show');
          document.getElementById('order-result').classList.remove('show');
        }
      } catch (err) {
        alert('ì¡°íšŒ ì˜¤ë¥˜: ' + err.message);
      }
    });

    // ì£¼ë¬¸ í‘œì‹œ
    function displayOrder(order) {
      const orderId = order.orderid || order.orderId;
      const customerName = order.customername || order.customerName;
      const phone = order.customerphone || order.phone;
      const totalAmount = order.totalprice || order.totalAmount;
      const paymentMethod = order.paymentmethod || order.paymentMethod || 'cash';
      
      document.getElementById('display-order-id').textContent = orderId;
      
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      updateStatus(order.status || 'pending');
      
      // ë°°ë‹¬ ì¤‘ì´ë©´ ì§€ë„ í‘œì‹œ
      if (order.status === 'delivering' && order.riderLat && order.riderLng) {
        showRiderMap(order);
      } else {
        document.getElementById('rider-map-container').style.display = 'none';
      }
      
      // ì£¼ë¬¸ ìƒì„¸
      let items = [];
      try {
        items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
      } catch (e) {
        items = order.items || [];
      }
      
      const detailsHtml = `
        <h3>ì£¼ë¬¸ ì •ë³´</h3>
        <div class="detail-row">
          <span>ê³ ê°ëª…</span>
          <span>${customerName}</span>
        </div>
        <div class="detail-row">
          <span>ì „í™”ë²ˆí˜¸</span>
          <span>${phone}</span>
        </div>
        <div class="detail-row">
          <span>ë°°ë‹¬ ì£¼ì†Œ</span>
          <span>${order.address}</span>
        </div>
        <div class="detail-row">
          <span>ì£¼ë¬¸ ë©”ë‰´</span>
          <span>${items.map(i => `${i.name} x ${i.quantity}`).join(', ')}</span>
        </div>
        <div class="detail-row">
          <span>ê²°ì œ ê¸ˆì•¡</span>
          <span><strong>${totalAmount.toLocaleString()}ì›</strong></span>
        </div>
        <div class="detail-row">
          <span>ê²°ì œ ë°©ë²•</span>
          <span>${paymentMethod === 'cash' ? 'í˜„ê¸ˆ' : 'ì¹´ë“œ'}</span>
        </div>
      `;
      
      document.getElementById('order-details').innerHTML = detailsHtml;
    }

    // ë¼ì´ë” ì§€ë„ í‘œì‹œ
    function showRiderMap(order) {
      const container = document.getElementById('rider-map-container');
      container.style.display = 'block';

      // ì•ˆì„± ê³µë„ì ê¸°ë³¸ ì¢Œí‘œ
      const defaultLat = 37.0047;
      const defaultLng = 127.2796;

      // ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜ (ê°„ë‹¨í•œ ì˜ˆì‹œ - ì‹¤ì œë¡œëŠ” Geocoding API ì‚¬ìš©)
      // ì•ˆì„± ì§€ì—­ ì£¼ì†Œ íŒŒì‹±
      let destLat = defaultLat;
      let destLng = defaultLng;
      
      // ì£¼ì†Œì—ì„œ ì¢Œí‘œ ì¶”ì • (ê°„ë‹¨í•œ ë¡œì§)
      if (order.address) {
        // ê³µë„ì ì¤‘ì‹¬ ì¢Œí‘œ
        if (order.address.includes('ê³µë„')) {
          destLat = 37.0047;
          destLng = 127.2796;
        }
        // ë¯¸ì–‘ë©´
        else if (order.address.includes('ë¯¸ì–‘')) {
          destLat = 37.0150;
          destLng = 127.2900;
        }
        // ëŒ€ë•ë©´
        else if (order.address.includes('ëŒ€ë•')) {
          destLat = 36.9900;
          destLng = 127.2700;
        }
        // ì–‘ì„±ë©´
        else if (order.address.includes('ì–‘ì„±')) {
          destLat = 37.0200;
          destLng = 127.3000;
        }
      }

      // Kakao Map ì´ˆê¸°í™”
      if (typeof kakao !== 'undefined' && kakao.maps) {
        kakao.maps.load(() => {
          const mapContainer = document.getElementById('rider-map');
          const mapOption = {
            center: new kakao.maps.LatLng(defaultLat, defaultLng),
            level: 4
          };
          map = new kakao.maps.Map(mapContainer, mapOption);

          // ë°°ë‹¬ì§€ ë§ˆì»¤
          const destPosition = new kakao.maps.LatLng(destLat, destLng);
          destinationMarker = new kakao.maps.Marker({
            position: destPosition,
            map: map,
            image: new kakao.maps.MarkerImage(
              'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_blue.png',
              new kakao.maps.Size(50, 50),
              { offset: new kakao.maps.Point(25, 50) }
            )
          });

          // ë°°ë‹¬ì§€ ì¸í¬ìœˆë„ìš°
          const destInfoWindow = new kakao.maps.InfoWindow({
            content: `<div style="padding: 5px; font-weight: 600;">ğŸ“ ë°°ë‹¬ì§€<br>${order.address}</div>`
          });
          destInfoWindow.open(map, destinationMarker);

          // ë¼ì´ë” ìœ„ì¹˜ ë§ˆì»¤
          if (order.riderLat && order.riderLng) {
            const riderPosition = new kakao.maps.LatLng(order.riderLat, order.riderLng);
            riderMarker = new kakao.maps.Marker({
              position: riderPosition,
              map: map,
              image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                new kakao.maps.Size(50, 50),
                { offset: new kakao.maps.Point(25, 50) }
              )
            });

            // ë¼ì´ë” ì¸í¬ìœˆë„ìš°
            const riderInfoWindow = new kakao.maps.InfoWindow({
              content: '<div style="padding: 5px; font-weight: 600;">ğŸ›µ ë°°ë‹¬ì› ìœ„ì¹˜</div>'
            });
            riderInfoWindow.open(map, riderMarker);

            // ë‘ ë§ˆì»¤ ì‚¬ì´ ì„  ê·¸ë¦¬ê¸°
            const polyline = new kakao.maps.Polyline({
              path: [riderPosition, destPosition],
              strokeWeight: 3,
              strokeColor: '#FF6B6B',
              strokeOpacity: 0.7,
              strokeStyle: 'dashed'
            });
            polyline.setMap(map);

            // ì§€ë„ ì¤‘ì‹¬ì„ ë‘ ë§ˆì»¤ ì¤‘ê°„ìœ¼ë¡œ
            const bounds = new kakao.maps.LatLngBounds();
            bounds.extend(riderPosition);
            bounds.extend(destPosition);
            map.setBounds(bounds);
          } else {
            // ë¼ì´ë” ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ë°°ë‹¬ì§€ë§Œ í‘œì‹œ
            map.setCenter(destPosition);
          }
        });
      } else {
        // ì¹´ì¹´ì˜¤ë§µì´ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ ë©”ì‹œì§€
        document.getElementById('rider-map').innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5; color: #666;">
            <div style="text-align: center;">
              <p style="font-size: 18px; margin-bottom: 10px;">ğŸ—ºï¸ ì§€ë„ ë¡œë”© ì¤‘...</p>
              <p style="font-size: 14px;">ì¹´ì¹´ì˜¤ë§µ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
            </div>
          </div>
        `;
      }

      // ì˜ˆìƒ ì‹œê°„ í‘œì‹œ
      if (order.estimatedTime) {
        document.getElementById('time-value').textContent = order.estimatedTime;
      } else {
        document.getElementById('time-value').textContent = 'ê³„ì‚° ì¤‘...';
      }
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(status) {
      const steps = document.querySelectorAll('.status-step');
      const statusOrder = ['pending', 'accepted', 'preparing', 'delivering', 'completed'];
      const currentIndex = statusOrder.indexOf(status);
      
      // pendingê³¼ acceptedëŠ” ê°™ì€ ë‹¨ê³„ë¡œ í‘œì‹œ (ì£¼ë¬¸ ì ‘ìˆ˜)
      let displayIndex = currentIndex;
      if (status === 'accepted') {
        displayIndex = 0; // ì²« ë²ˆì§¸ ë‹¨ê³„ì— í‘œì‹œ
      } else if (currentIndex > 1) {
        displayIndex = currentIndex - 1; // acceptedë¥¼ ê±´ë„ˆë›°ë¯€ë¡œ -1
      }
      
      steps.forEach((step, index) => {
        step.classList.remove('active', 'current');
        
        if (index < displayIndex) {
          step.classList.add('active');
        } else if (index === displayIndex) {
          step.classList.add('active', 'current');
        }
      });
    }

    // ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸
    socket.on('order-status-changed', (data) => {
      console.log('ğŸ“¡ ìƒíƒœ ë³€ê²½:', data);
      if (data.orderId === currentOrderId) {
        console.log('âœ… í˜„ì¬ ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸:', data.status);
        updateStatus(data.status);
        
        // ë°°ë‹¬ ì¤‘ì´ë©´ ì£¼ë¬¸ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
        if (data.status === 'delivering') {
          fetch(`/api/orders/${currentOrderId}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                displayOrder(data.order);
              }
            });
        }
        
        // ì•Œë¦¼ í‘œì‹œ
        showNotification(data.status);
      }
    });

    // ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    socket.on('rider-location-updated', (data) => {
      if (data.orderId === currentOrderId) {
        if (map && riderMarker && typeof kakao !== 'undefined' && kakao.maps) {
          const position = new kakao.maps.LatLng(data.lat, data.lng);
          riderMarker.setPosition(position);
          
          // ë°°ë‹¬ì§€ì™€ì˜ ê±°ë¦¬ ê³„ì‚°í•˜ì—¬ ì˜ˆìƒ ì‹œê°„ ì—…ë°ì´íŠ¸
          if (destinationMarker) {
            const destPos = destinationMarker.getPosition();
            const distance = calculateDistance(data.lat, data.lng, destPos.getLat(), destPos.getLng());
            const estimatedMinutes = Math.ceil(distance / 0.5); // kmë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜ (ëŒ€ëµ 30km/h ê°€ì •)
            
            if (data.estimatedTime) {
              document.getElementById('time-value').textContent = data.estimatedTime;
            } else {
              document.getElementById('time-value').textContent = estimatedMinutes;
            }
            
            // ì§€ë„ ì¤‘ì‹¬ ì¡°ì •
            const bounds = new kakao.maps.LatLngBounds();
            bounds.extend(position);
            bounds.extend(destPos);
            map.setBounds(bounds);
          }
        }
        
        if (data.estimatedTime) {
          document.getElementById('time-value').textContent = data.estimatedTime;
        }
      }
    });

    // ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚° (Haversine ê³µì‹)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    // ìƒíƒœ ë³€ê²½ ì•Œë¦¼
    function showNotification(status) {
      const messages = {
        'pending': 'ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
        'accepted': 'ì£¼ë¬¸ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤',
        'preparing': 'ì¡°ë¦¬ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤! ğŸ‘¨â€ğŸ³',
        'delivering': 'ë°°ë‹¬ì›ì´ ì¶œë°œí–ˆìŠµë‹ˆë‹¤! ğŸšš',
        'completed': 'ë°°ë‹¬ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…'
      };
      
      const message = messages[status] || 'ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤';
      
      // ê°„ë‹¨í•œ ì•Œë¦¼ (í•„ìš”ì‹œ ë” ë©‹ì§€ê²Œ ê¾¸ë°€ ìˆ˜ ìˆìŒ)
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s;
        font-weight: 600;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // CSS ì• ë‹ˆë©”ì´ì…˜
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>

